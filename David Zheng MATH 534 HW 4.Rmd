---
title: "MATH 534 HW 4"
author: "David Zheng"
date: "2025-09-27"
output: md_document
---

# Q2
How many rows are available in the Measurements table of the Smith College Wideband Auditory Immittance database?
```{r}
library(RMariaDB)
library(tidyverse)
library(mdsr)

con <- dbConnect(
  MariaDB(), host = "scidb.smith.edu",
  user = "waiuser", password = "smith_waiDB", 
  dbname = "wai"
)
Measurements <- tbl(con, "Measurements")

dbGetQuery(con, "
  SELECT COUNT(*) AS n_rows
  FROM Measurements;
")
```
There are 5052304 rows available in the Measurements table of the Smith College Wideband Auditory Immittance database.

# Q3
Identify what years of data are available in the flights table of the airlines database.
```{r}
con <- dbConnect_scidb("airlines")

flights <- tbl(con, "flights")

dbGetQuery(con, "
  SELECT DISTINCT year
  FROM flights
  ORDER BY year;
")
```
The years of data that are available in the flights table of the airlines database are 2013, 2014, and 2015. 


# Q4
Use the dbConnect_scidb function to connect to the airlines database to answer the following problem.
```{r}
con <- dbConnect_scidb("airlines")

dbListTables(con)

flights  <- tbl(con, "flights")
airports <- tbl(con, "airports")
carriers <- tbl(con, "carriers")

flights
airports
carriers
```

# Q4.1
How many domestic flights flew into Dallas-Fort Worth (DFW) on May 14, 2015?
```{r}
dbGetQuery(con, "
  SELECT COUNT(*) AS domestic_flights
  FROM flights
  WHERE year=2015 AND month=5 AND day=14
    AND dest='DFW'
    AND origin IN (
      SELECT faa FROM airports
      WHERE country IN ('United States','USA')
    );
")
```
736 domestic flights flew into Dallas-Fort Worth (DFW) on May 14, 2015.

# Q4.2
Of all the destinations from Chicago O’Hare (ORD), which were the most common in 2015?
```{r}
dbGetQuery(con, "
  SELECT dest, name AS airport, COUNT(*) AS arrivals_from_chicago
  FROM flights 
  LEFT JOIN airports ON dest = faa
  WHERE year = 2015 AND origin = 'ORD'
  GROUP BY dest, airport
  ORDER BY arrivals_from_chicago DESC
  LIMIT 10;
")
```
Of all the destinations from Chicago O’Hare (ORD), La Guardia (LGA) was the most common in 2015. 

# Q4.3
Which airport had the highest average arrival delay time in 2015?
```{r}
dbGetQuery(con, "
  SELECT dest, name AS airport, AVG(arr_delay) AS average_arrival_delay
  FROM flights
  LEFT JOIN airports ON dest = faa
  WHERE year = 2015 AND arr_delay IS NOT NULL
  GROUP BY dest, airport
  ORDER BY average_arrival_delay DESC
  LIMIT 1;
")
```
Saint Cloud Regional Airport had the highest average arrival delay time in 2015.

# Q4.4
How many domestic flights came into or flew out of Bradley Airport (BDL) in 2015?
```{r}
dbGetQuery(con, "
  SELECT COUNT(*) AS domestic_flights
  FROM flights
  WHERE year = 2015
    AND (origin = 'BDL' OR dest = 'BDL')
    AND origin IN (SELECT faa FROM airports WHERE country IN ('United States','USA'))
    AND dest IN (SELECT faa FROM airports WHERE country IN ('United States','USA'));
")
```
There were 40051 domestic flights that came into or flew out of Bradley Airport (BDL) in 2015.

# Q4.5
List the airline and flight number for all flights between LAX and JFK on September 26th, 2015.
```{r}
dbGetQuery(con, "
  SELECT c.name AS airline, f.carrier, f.flight, f.origin, f.dest
  FROM flights AS f
  LEFT JOIN carriers AS c ON f.carrier = c.carrier
  WHERE f.year = 2015 AND f.month = 9 AND f.day = 26
    AND ((f.origin='LAX' AND f.dest='JFK') OR (f.origin='JFK' AND f.dest='LAX'))
  ORDER BY f.origin, f.dest, airline, f.flight;
")
```


# Q5
Wideband acoustic immittance (WAI) is an area of biomedical research that strives to develop WAI measurements as noninvasive auditory diagnostic tools. WAI measurements are reported in many related formats, including absorbance, admittance, impedance, power reflectance, and pressure reflectance.
```{r}
library(RMariaDB)
db <- dbConnect(
  MariaDB(), 
  user = "waiuser", 
  password = "smith_waiDB", 
  host = "scidb.smith.edu", 
  dbname = "wai"
)

dbListTables(db)

Subjects <- tbl(db, "Subjects")
Measurements <- tbl(db, "Measurements")

Subjects
Measurements
```


# Q5a
How many female subjects are there in total across all studies?
```{r}
dbGetQuery(db, "
  SELECT COUNT(*) AS n_female
  FROM Subjects
  WHERE Sex = 'Female';
")
```
There were 4727 females in total across all studies.

# Q5b
Find the average absorbance for participants for each study, ordered by highest to lowest value.
```{r}
dbGetQuery(db, "
  SELECT Identifier AS study,
         AVG(Absorbance) AS avg_absorbance
  FROM Measurements
  GROUP BY Identifier
  ORDER BY avg_absorbance DESC;
")
```

# Q5c
Write a query to count all the measurements with a calculated absorbance of less than 0.
```{r}
dbGetQuery(db, "
  SELECT COUNT(*) AS n_negative_absorbance
  FROM Measurements
  WHERE absorbance < 0;
")
```
There were 28694 measurements with a calculated absorbance of less than 0. 

# Q6
The following open-ended question may require more than one query and a thoughtful response. Based on data from 2013 only, and assuming that transportation to the airport is not an issue, would you rather fly out of JFK, LaGuardia (LGA), or Newark (EWR)? Why or why not? Use the dbConnect_scidb function to connect to the airlines database.
```{r}
con <- dbConnect_scidb("airlines")
flights <- tbl(con, "flights")
```

```{r}
dbGetQuery(con, "
  SELECT origin,
         COUNT(*) AS n_flights,
         AVG(dep_delay) AS avg_delay,
         AVG(CASE WHEN dep_delay IS NULL AND arr_delay IS NULL THEN 1 ELSE 0 END) AS cancel_rate,
         AVG(CASE WHEN dep_delay <= 15 THEN 1 ELSE 0 END) AS on_time_rate
  FROM flights
  WHERE year = 2013
    AND origin IN ('JFK', 'LGA', 'EWR')
  GROUP BY origin
  ORDER BY avg_delay;
")
```
Based on the 2013 data, I would choose to fly out of LaGuardia (LGA) airport out of all the airports in the NYC area. It had the highest on-time departure rate at 81.67% and the lowest average departure delay of 10.0352 minutes compared to the other New York area airports. All three airports had no cancellations. While Newark (EWR) offered more flights than LaGuardia at 120835 flights for Newark compared to 104662 flights for LaGuardia, I find punctuality and cancellation rate more valuable than the number of flights offered. Therefore, LaGuardia (LGA) would be my preferred choice.